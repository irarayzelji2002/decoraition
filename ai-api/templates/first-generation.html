<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>First Generation</title>
	</head>
	<body>
		<h1>First Image Generation Test</h1>

		<form id="generate_image_form" enctype="multipart/form-data">
			<!-- Prompt -->
			<label for="prompt">Prompt:</label><span id="prompt_err"></span
			><br />
			<input type="text" id="prompt" name="prompt" required /><br /><br />
			<!-- Number of Images -->
			<label for="number_of_images">Number of Images:</label
			><span id="number_of_images_err"></span><br />
			<input
				type="number"
				id="number_of_images"
				name="number_of_images"
				min="1"
				max="4"
				value="1"
				required
			/><br /><br />
			<!-- Color Palette -->
			<label for="color_palette"
				>Color Palette (comma-separated hex codes):</label
			><br />
			<input
				type="text"
				id="color_palette"
				name="color_palette"
			/><br /><br />
			<!-- Base Image -->
			<label for="base_image">Base Image:</label>
			<span id="base_image_err"></span>
			<input
				type="file"
				id="base_image"
				name="base_image"
				accept="image/png, image/jpg, image/jpeg"
			/><br /><br />
			<!-- Style Reference -->
			<label for="style_reference">Style Reference:</label>
			<span id="style_reference_err"></span>
			<input
				type="file"
				id="style_reference"
				name="style_reference"
				accept="image/png, image/jpg, image/jpeg"
			/><br /><br />
			<!-- Generate button -->
			<button type="button" onclick="generateFirstImage()">
				Generate
			</button>
		</form>

		<button onclick="document.location='/test/next-generation'">
			Next Generation
		</button>

		<div id="image_container"></div>

		<script>
			async function generateFirstImage() {
				// Get form elements
				const prompt = document.getElementById("prompt").value.trim();
				const number_of_images = document
					.getElementById("number_of_images")
					.value.trim();
				const color_palette = document
					.getElementById("color_palette")
					.value.trim();
				const base_image =
					document.getElementById("base_image").files[0];
				const style_reference =
					document.getElementById("style_reference").files[0];

				// Validation
				if (!prompt) {
					document.getElementById("prompt_err").innerHTML =
						"Prompt is required.";
					return;
				}
				if (
					!number_of_images ||
					number_of_images < 1 ||
					number_of_images > 4
				) {
					document.getElementById("number_of_images_err").innerHTML =
						"Please enter a valid number of images (1-4).";
					return;
				}
				if (base_image) {
					const validExtensions = ["jpg", "jpeg", "png"];
					const fileExtension = base_image.name
						.split(".")
						.pop()
						.toLowerCase();

					if (!validExtensions.includes(fileExtension)) {
						document.getElementById("base_image_err").innerHTML =
							"Invalid file type. Please upload a JPG or PNG image.";
						return;
					}
				}
				if (style_reference) {
					const validExtensions = ["jpg", "jpeg", "png"];
					const fileExtension = style_reference.name
						.split(".")
						.pop()
						.toLowerCase();

					if (!validExtensions.includes(fileExtension)) {
						document.getElementById(
							"style_reference_err"
						).innerHTML =
							"Invalid file type. Please upload a JPG or PNG image.";
						return;
					}
				}

				// Create FormData object
				const formData = new FormData();
				formData.append("prompt", prompt);
				formData.append("number_of_images", number_of_images);
				if (color_palette) {
					const colorsArray = color_palette
						.split(",")
						.map((color) => color.trim());
					formData.append(
						"color_palette",
						JSON.stringify(colorsArray)
					);
				}
				if (base_image) {
					formData.append("base_image", base_image);
				}
				if (style_reference) {
					formData.append("style_reference", style_reference);
				}
				console.log("Form Data:");
				console.log(formData);

				// Fetch API
				try {
					const response = await fetch("/generate-first-image", {
						method: "POST",
						body: formData,
					});

					if (!response.ok) {
						throw new Error("Failed to generate image");
					}

					const data = await response.json();
					const imageContainer =
						document.getElementById("image_container");
					imageContainer.innerHTML = "";

					data.image_paths.forEach((path) => {
						const img = document.createElement("img");
						img.src = path;
						img.alt = "Generated Image";
						img.style.maxWidth = "100%";
						img.style.height = "auto";
						imageContainer.appendChild(img);
					});
				} catch (error) {
					console.error("Error:", error);
				}
			}
		</script>
	</body>
</html>
